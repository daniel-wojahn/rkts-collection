<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <link rel="stylesheet" href="css/owui-widget.css">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div class="owui-chat-container">
        <div class="owui-chat-header">
            <h3 class="owui-chat-title">rKTs Collections Assistant</h3>
            <button class="owui-chat-close" onclick="window.parent.postMessage('close', '*')">Ã—</button>
        </div>
        
        <div class="owui-chat-messages" id="messages">
            <!-- Messages will be added here -->
        </div>
        
        <div class="owui-typing-indicator" id="typing-indicator">
            Assistant is typing...
        </div>
        
        <div class="owui-chat-input-container">
            <textarea 
                class="owui-chat-input" 
                id="user-input" 
                placeholder="Type your message..." 
                rows="1"
                onkeydown="handleKeyDown(event)"></textarea>
            <button class="owui-chat-send" id="send-button" onclick="sendMessage()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </div>
    </div>

    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        let apiKey = urlParams.get('api_key') || '';
        const endpoint = urlParams.get('endpoint') || '/.netlify/functions/api-proxy'; // Using Netlify serverless proxy to avoid mixed content errors
        const model = urlParams.get('model') || 'rkts-research-tool';
        const systemPrompt = urlParams.get('system_prompt') || '';
        const title = urlParams.get('title') || 'rKTs Collections Assistant';
        const greeting = urlParams.get('greeting') || 'Hello! How can I help you with your research today?';
        const primaryColor = urlParams.get('primary_color') || '#007bff';
        
        // Set dynamic styles
        document.documentElement.style.setProperty('--primary-color', primaryColor);
        document.querySelector('.owui-chat-title').textContent = title;
        
        // Initialize conversation history
        const conversationHistory = [];
        
        // Initialize DOM elements - must be defined before any functions that use them
        let messagesContainer;
        let userInput;
        let sendButton;
        let typingIndicator;
        
        // Function to initialize DOM elements
        function initializeDOMElements() {
            messagesContainer = document.getElementById('messages');
            userInput = document.getElementById('user-input');
            sendButton = document.getElementById('send-button');
            typingIndicator = document.getElementById('typing-indicator');
            
            // Hide typing indicator initially
            if (typingIndicator) {
                typingIndicator.style.display = 'none';
            }
        }
        
        // Initialize DOM elements when the document is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeDOMElements();
            
            // If API key is provided via URL, initialize immediately
            if (apiKey) {
                initializeChat();
            } else {
                fetchApiKey();
            }
        });
        
        // Function to fetch API key from Netlify function if not provided in URL
        function fetchApiKey() {
            fetch('/.netlify/functions/get-api-key')
                .then(response => response.json())
                .then(data => {
                    if (data && data.apiKey) {
                        apiKey = data.apiKey;
                        initializeChat();
                    } else {
                        addMessage('Error: Could not retrieve API key.', 'bot', true);
                    }
                })
                .catch(error => {
                    console.error('Error fetching API key:', error);
                    addMessage('Error: Could not retrieve API key. Please check the server configuration.', 'bot', true);
                });
        }
        
        // Initialize chat with greeting
        function initializeChat() {
            if (greeting) {
                addMessage(greeting, 'bot');
            }
            
            // Auto-resize textarea as user types
            if (userInput) {
                userInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });
            }
        }
        
        // Handle keydown events (Enter to send)
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        // Add message to chat
        function addMessage(text, sender, isError = false) {
            if (!messagesContainer) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `owui-chat-message ${sender === 'user' ? 'owui-user-message' : 'owui-bot-message'}`;
            
            if (isError) {
                messageDiv.classList.add('owui-error-message');
            }
            
            // Process markdown in bot messages
            if (sender === 'bot') {
                messageDiv.innerHTML = markdownToHtml(text);
            } else {
                messageDiv.textContent = text;
            }
            
            messagesContainer.appendChild(messageDiv);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Convert markdown to HTML
        function markdownToHtml(text) {
            if (!text) return '';
            
            // Code blocks with language
            text = text.replace(/```(\w+)?\n([\s\S]*?)\n```/g, function(match, language, code) {
                return `<pre class="owui-code-block ${language ? 'language-' + language : ''}"><code>${escapeHtml(code)}</code></pre>`;
            });
            
            // Inline code
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Bold
            text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            
            // Italic
            text = text.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            
            // Headers
            text = text.replace(/^### (.*$)/gm, '<h3>$1</h3>');
            text = text.replace(/^## (.*$)/gm, '<h2>$1</h2>');
            text = text.replace(/^# (.*$)/gm, '<h1>$1</h1>');
            
            // Lists
            text = text.replace(/^\s*[\-\*] (.*$)/gm, '<li>$1</li>');
            text = text.replace(/(<li>.*<\/li>)/gms, '<ul>$1</ul>');
            
            // Numbered lists
            text = text.replace(/^\s*\d+\. (.*$)/gm, '<li>$1</li>');
            text = text.replace(/(<li>.*<\/li>)/gms, function(match) {
                if (match.includes('</ul>')) return match;
                return '<ol>' + match + '</ol>';
            });
            
            // Links
            text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
            
            // Paragraphs
            text = text.replace(/\n\s*\n/g, '</p><p>');
            text = '<p>' + text + '</p>';
            text = text.replace(/<p><\/p>/g, '');
            
            // Line breaks (only within paragraphs)
            text = text.replace(/<p>([\s\S]*?)<\/p>/g, function(match, content) {
                return '<p>' + content.replace(/\n/g, '<br>') + '</p>';
            });
            
            return text;
        }
        
        // Escape HTML to prevent XSS
        function escapeHtml(text) {
                
                // Hide typing indicator initially
                if (typingIndicator) {
                    typingIndicator.style.display = 'none';
                }
            }
            
            // Initialize DOM elements when the document is loaded
            document.addEventListener('DOMContentLoaded', function() {
                initializeDOMElements();
                
                // If API key is provided via URL, initialize immediately
                if (apiKey) {
                    initializeChat();
                } else {
                    fetchApiKey();
                }
            });
            
            // Function to fetch API key from Netlify function if not provided in URL
            function fetchApiKey() {
                fetch('/.netlify/functions/get-api-key')
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.apiKey) {
                            apiKey = data.apiKey;
                            initializeChat();
                        } else {
                            addMessage('Error: Could not retrieve API key.', 'bot', true);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching API key:', error);
                        addMessage('Error: Could not retrieve API key. Please check the server configuration.', 'bot', true);
                    });
            }
            
            // Initialize chat with greeting
            function initializeChat() {
                if (greeting) {
                    addMessage(greeting, 'bot');
                }
                
                // Auto-resize textarea as user types
                if (userInput) {
                    userInput.addEventListener('input', function() {
                        this.style.height = 'auto';
                        this.style.height = (this.scrollHeight) + 'px';
                    });
                }
            }
            
            // Handle keydown events (Enter to send)
            function handleKeyDown(event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    sendMessage();
                }
            }
            
            // Add message to chat
            function addMessage(text, sender, isError = false) {
                if (!messagesContainer) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `owui-chat-message ${sender === 'user' ? 'owui-user-message' : 'owui-bot-message'}`;
                
                if (isError) {
                    messageDiv.classList.add('owui-error-message');
                }
                
                // Process markdown in bot messages
                if (sender === 'bot') {
                    messageDiv.innerHTML = markdownToHtml(text);
                } else {
                    messageDiv.textContent = text;
                }
                
                messagesContainer.appendChild(messageDiv);
                
                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            // Convert markdown to HTML
            function markdownToHtml(text) {
                if (!text) return '';
                
                // Code blocks with language
                text = text.replace(/```(\w+)?\n([\s\S]*?)\n```/g, function(match, language, code) {
                    return `<pre class="owui-code-block ${language ? 'language-' + language : ''}"><code>${escapeHtml(code)}</code></pre>`;
                });
                
                // Inline code
                text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
                
                // Bold
                text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
                
                // Italic
                text = text.replace(/\*([^*]+)\*/g, '<em>$1</em>');
                
                // Headers
                text = text.replace(/^### (.*$)/gm, '<h3>$1</h3>');
                text = text.replace(/^## (.*$)/gm, '<h2>$1</h2>');
                text = text.replace(/^# (.*$)/gm, '<h1>$1</h1>');
                
                // Lists
                text = text.replace(/^\s*[\-\*] (.*$)/gm, '<li>$1</li>');
                text = text.replace(/(<li>.*<\/li>)/gms, '<ul>$1</ul>');
                
                // Numbered lists
                text = text.replace(/^\s*\d+\. (.*$)/gm, '<li>$1</li>');
                text = text.replace(/(<li>.*<\/li>)/gms, function(match) {
                    if (match.includes('</ul>')) return match;
                    return '<ol>' + match + '</ol>';
                });
                
                // Links
                text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
                
                // Paragraphs
                text = text.replace(/\n\s*\n/g, '</p><p>');
                text = '<p>' + text + '</p>';
                text = text.replace(/<p><\/p>/g, '');
                
                // Line breaks (only within paragraphs)
                text = text.replace(/<p>([\s\S]*?)<\/p>/g, function(match, content) {
                    return '<p>' + content.replace(/\n/g, '<br>') + '</p>';
                });
                
                return text;
            }
            
            // Escape HTML to prevent XSS
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // Function to make API requests
            function makeApiRequest(endpoint, apiKey, message) {
                console.log(`Making API request to: ${endpoint}`);
                console.log(`API Key present: ${apiKey ? 'Yes' : 'No'}`);
                
                // Prepare the request payload
                const payload = {
                    model: "gpt-3.5-turbo",
                    messages: [
                        { role: "system", content: "You are a helpful assistant for Tibetan Buddhist texts." },
                        { role: "user", content: message }
                    ],
                    temperature: 0.7,
                    max_tokens: 800
                };
                
                // First try direct request to the endpoint
                // If it's HTTP and we're on HTTPS, it will fail with mixed content error
                // In that case, we'll use the proxy
                
                // Check if the endpoint is already HTTPS
                const isHttps = endpoint.startsWith('https://');
                
                // If it's HTTPS, try direct request first
                if (isHttps) {
                    console.log('Endpoint is HTTPS, trying direct request...');
                    return fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(payload)
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`API request failed with status ${response.status}`);
                        }
                        return response.json();
                    })
                    .catch(error => {
                        console.error('Direct HTTPS request failed:', error);
                        console.log('Falling back to proxy...');
                        
                        // Fall back to proxy
                        return useProxy(endpoint, apiKey, payload);
                    });
                } else {
                    // For HTTP endpoints, use proxy directly
                    console.log('Endpoint is HTTP, using proxy...');
                    return useProxy(endpoint, apiKey, payload);
                }
            }
            
            // Helper function to use the proxy
            function useProxy(originalEndpoint, apiKey, payload) {
                // Use Netlify function as proxy
                const proxyUrl = '/.netlify/functions/api-proxy';
                
                console.log(`Using proxy at: ${proxyUrl}`);
                
                return fetch(proxyUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(payload)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Proxy request failed with status ${response.status}`);
                    }
                    return response.json();
                })
                .catch(error => {
                    console.error('Proxy request failed:', error);
                    throw new Error(`Failed to get response: ${error.message}`);
                });
            }
            
            // Send message function
            function sendMessage() {
                // Make sure DOM elements are initialized
                if (!userInput || !sendButton || !typingIndicator || !messagesContainer) {
                    console.error('DOM elements not initialized');
                    return;
                }
                
                const message = userInput.value.trim();
                
                if (!message) return;
                
                // Add user message to chat
                addMessage(message, 'user');
                
                // Add to conversation history
                conversationHistory.push({
                    role: 'user',
                    content: message
                });
                
                // Clear input
                userInput.value = '';
                userInput.style.height = 'auto';
                
                // Disable input while waiting for response
                userInput.disabled = true;
                sendButton.disabled = true;
                
                // Show typing indicator
                typingIndicator.style.display = 'block';
                
                // Check if API key is available
                if (!apiKey) {
                    typingIndicator.style.display = 'none';
                    userInput.disabled = false;
                    sendButton.disabled = false;
                    addMessage('Error: API key is missing. Please provide an API key via URL parameter.', 'bot', true);
                    return;
                }
                
                // Use the API proxy endpoint which handles HTTP/HTTPS issues for us
                makeApiRequest(endpoint, apiKey, message)
                .then(response => {
                    typingIndicator.style.display = 'none';
                    
                    // Extract the response content
                    const responseContent = response.choices && response.choices[0] && response.choices[0].message 
                        ? response.choices[0].message.content 
                        : 'Sorry, I couldn\'t process your request.';
                    
                    // Add to conversation history
                    conversationHistory.push({
                        role: 'assistant',
                        content: responseContent
                    });
                    
                    addMessage(responseContent, 'bot');
                    
                    // Re-enable input
                    userInput.disabled = false;
                    sendButton.disabled = false;
                    userInput.focus();
                })
                .catch(error => {
                    console.error('Error:', error);
                    typingIndicator.style.display = 'none';
                    
                    let errorMessage;
                    if (error.message === 'Failed to fetch') {
                        // Connection issues with API proxy or target API
                        errorMessage = `Connection error: Unable to connect to the API. This may be due to:
1. The API server is not accessible or offline
2. Network connectivity issues
3. The API proxy function is not properly deployed

Please check that the API server is running and accessible.`;
                } else {
                    errorMessage = `Sorry, there was an error connecting to the API: ${error.message}. Please check your API key and endpoint configuration.`;
                }
                
                addMessage(errorMessage, 'bot', true);
                
                // Re-enable input
                userInput.disabled = false;
                sendButton.disabled = false;
                userInput.focus();
            });
        }
        
        // Send message function
        function sendMessage() {
            // Make sure DOM elements are initialized
            if (!userInput || !sendButton || !typingIndicator || !messagesContainer) {
                console.error('DOM elements not initialized');
                return;
            }
            
            const message = userInput.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addMessage(message, 'user');
            
            // Add to conversation history
            conversationHistory.push({
                role: 'user',
                content: message
            });
            
            // Clear input
            userInput.value = '';
            userInput.style.height = 'auto';
            
            // Disable input while waiting for response
            userInput.disabled = true;
            sendButton.disabled = true;
            
            // Show typing indicator
            typingIndicator.style.display = 'block';
            
            // Check if API key is available
            if (!apiKey) {
                typingIndicator.style.display = 'none';
                userInput.disabled = false;
                sendButton.disabled = false;
                addMessage('Error: API key is missing. Please provide an API key via URL parameter.', 'bot', true);
                return;
            }
            
            // Use the API proxy endpoint which handles HTTP/HTTPS issues for us
            makeApiRequest(endpoint);
        }
        
        // Handle window resize events to adjust the chat container
        window.addEventListener('resize', function() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        });
    </script>
</body>
</html>
